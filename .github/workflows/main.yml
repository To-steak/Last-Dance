name: Auto Daily Commit & Release (Unity)

on:
  schedule:
    - cron: '0 15 * * *' # 한국 시간 밤 12시
  workflow_dispatch:
    inputs: {}

# 릴리즈 생성 및 커밋 푸시를 위해 쓰기 권한 필수
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        run: |
          git add .
          # 현재 날짜 변수 생성 (예: 2025-11-26)
          CURRENT_DATE=$(date +'%Y-%m-%d')
          echo "DATE_TAG=$CURRENT_DATE" >> $GITHUB_ENV
          
          git commit -m "[BOT] Daily auto-commit: $CURRENT_DATE" || echo "No changes to commit"
          git push

      - uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: .
          githubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Project (Windows)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: StandaloneWindows64
          buildName: MyGame

      - name: Zip Build
        run: |
          cd build/StandaloneWindows64
          zip -r ../../MyGame_${{ env.DATE_TAG }}.zip .
          cd ../..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.DATE_TAG }} # 태그명: build-2025-11-26
          name: Daily Build ${{ env.DATE_TAG }}
          body: |
            Auto-generated Daily Build
            - Date: ${{ env.DATE_TAG }}
            - Platform: Windows 64-bit
          files: Last-Dance_${{ env.DATE_TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
